# Story 1.17: Add Rustdoc Documentation

## Status
Draft

## Story
**As a** library user,
**I want** comprehensive rustdoc on all public types and functions,
**so that** I can discover and understand the API through `cargo doc` and docs.rs.

## Acceptance Criteria

**Documentation Coverage:**
1. - [ ] Module-level docs with overview and examples
2. - [ ] `SearchOptions` struct fully documented
3. - [ ] `SearchResult` struct fully documented
4. - [ ] `Match` struct fully documented
5. - [ ] `SearchResultIterator` fully documented
6. - [ ] `search_iter()` function fully documented
7. - [ ] `search()` function fully documented
8. - [ ] `SqlDialect` documented in re-export

**Example Quality:**
9. - [ ] All examples are complete (can be run as-is)
10. - [ ] Examples show common use cases
11. - [ ] Examples demonstrate error handling
12. - [ ] Examples are tested via `cargo test --doc`

**Documentation Quality:**
13. - [ ] Errors are documented with `# Errors` sections
14. - [ ] Return types are documented with `# Returns` sections
15. - [ ] Arguments are documented with `# Arguments` sections
16. - [ ] Links between related items work

**Build Verification:**
17. - [ ] `cargo doc` generates without warnings
18. - [ ] `cargo test --doc` passes
19. - [ ] Doc tests don't depend on external state

## Tasks / Subtasks

- [ ] Add module-level documentation to `src/lib.rs` (AC: 1)
  - [ ] Quick start example
  - [ ] Streaming API introduction
  - [ ] Query language reference
  - [ ] Feature flags section
- [ ] Document all structs (AC: 2, 3, 4, 5)
  - [ ] Full descriptions
  - [ ] Field documentation
  - [ ] Usage examples
  - [ ] Default values table for SearchOptions
- [ ] Document all functions (AC: 6, 7)
  - [ ] Arguments section
  - [ ] Returns section
  - [ ] Errors section
  - [ ] Multiple examples
- [ ] Document re-exports (AC: 8)
- [ ] Ensure example quality (AC: 9, 10, 11, 12)
- [ ] Add cross-references and links (AC: 16)
- [ ] Verify build (AC: 17, 18, 19)

## Dev Notes

### Location
- Primary file: `src/lib.rs`
- [Source: docs/epics/library-api-epic.md - Story 17]

### Why Comprehensive Docs Matter
Users discovering rdump through `cargo doc` or docs.rs should be able to:
1. Understand what the library does
2. See working examples immediately
3. Understand the query language
4. Know about error conditions
5. Choose between `search()` and `search_iter()`

### Testing Doc Examples
```bash
# Build documentation
cargo doc --open

# Run all doc tests
cargo test --doc

# Run specific doc test
cargo test --doc search_iter
```

### Doc Test Features
Use `# ` to hide boilerplate in doc examples:
```rust
/// ```rust
/// # fn main() -> anyhow::Result<()> {
/// let results = search("ext:rs", SearchOptions::default())?;
/// # Ok(())
/// # }
/// ```
```

### Function Documentation Pattern
Each public function should have:
- Brief description
- Arguments section
- Returns section
- Errors section
- Multiple examples showing common patterns

### Complete Implementation

#### Module-Level Documentation

```rust
//! # rdump - Code Search Library
//!
//! rdump provides a library API for semantic code search using tree-sitter.
//! You can search for files by extension, language, function names, and more
//! using a powerful query language.
//!
//! ## Quick Start
//!
//! ```rust
//! use rdump::{search, SearchOptions};
//!
//! fn main() -> anyhow::Result<()> {
//!     // Find all Rust files with a main function
//!     let results = search("ext:rs & func:main", SearchOptions::default())?;
//!
//!     for result in &results {
//!         println!("{}: {} matches",
//!             result.path.display(),
//!             result.matches.len()
//!         );
//!     }
//!
//!     Ok(())
//! }
//! ```
//!
//! ## Streaming API
//!
//! For large codebases, use `search_iter()` to process results lazily:
//!
//! ```rust
//! use rdump::{search_iter, SearchOptions};
//!
//! # fn main() -> anyhow::Result<()> {
//! // Find first 10 matching files
//! let first_ten: Vec<_> = search_iter("ext:rs", SearchOptions::default())?
//!     .take(10)
//!     .filter_map(Result::ok)
//!     .collect();
//! # Ok(())
//! # }
//! ```
//!
//! ## Query Language
//!
//! rdump uses RQL (rdump Query Language) for searches:
//!
//! | Predicate | Description | Example |
//! |-----------|-------------|---------|
//! | `ext:` | File extension | `ext:rs` |
//! | `lang:` | Programming language | `lang:python` |
//! | `func:` | Function name | `func:main` |
//! | `class:` | Class name | `class:User` |
//! | `content:` | Text content | `content:TODO` |
//!
//! Combine with operators:
//! - `&` - AND
//! - `|` - OR
//! - `!` - NOT
//! - `()` - Grouping
//!
//! Example: `ext:rs & (func:new | func:default)`
//!
//! ## Feature Flags
//!
//! - `async` - Enable async API with tokio support
//!
//! ```toml
//! [dependencies]
//! rdump = { version = "0.1", features = ["async"] }
//! ```
```

#### Function Documentation Pattern

```rust
/// Search for files matching a query (streaming, memory-efficient)
///
/// Returns an iterator that yields results one at a time, loading file
/// content only when each result is consumed. This is the recommended
/// API for large codebases.
///
/// # Arguments
///
/// * `query` - An RQL query string (see module docs for syntax)
/// * `options` - Search configuration options
///
/// # Returns
///
/// An iterator yielding `Result<SearchResult>` for each matching file.
///
/// # Errors
///
/// Returns an error if:
/// - The query syntax is invalid
/// - The root directory doesn't exist or isn't accessible
/// - A preset name is not found in the preset registry
///
/// Individual iterator items may also return errors for:
/// - File read failures
/// - Permission errors
/// - Invalid UTF-8 content
///
/// # Examples
///
/// Basic usage:
///
/// ```rust
/// use rdump::{search_iter, SearchOptions};
///
/// # fn main() -> anyhow::Result<()> {
/// let results = search_iter("ext:rs", SearchOptions::default())?;
///
/// for result in results {
///     let result = result?;
///     println!("{}", result.path.display());
/// }
/// # Ok(())
/// # }
/// ```
///
/// Early termination:
///
/// ```rust
/// # use rdump::{search_iter, SearchOptions};
/// # fn main() -> anyhow::Result<()> {
/// // Find first 5 matches only
/// let first_five: Vec<_> = search_iter("ext:rs", SearchOptions::default())?
///     .take(5)
///     .collect::<Result<Vec<_>, _>>()?;
/// # Ok(())
/// # }
/// ```
///
/// Skip errors:
///
/// ```rust
/// # use rdump::{search_iter, SearchOptions};
/// # fn main() -> anyhow::Result<()> {
/// let results: Vec<_> = search_iter("ext:rs", SearchOptions::default())?
///     .filter_map(Result::ok)
///     .collect();
/// # Ok(())
/// # }
/// ```
pub fn search_iter(
    query: &str,
    options: SearchOptions,
) -> Result<SearchResultIterator> {
    // ... implementation
}
```

#### Type Documentation Pattern

```rust
/// Options for performing a search (library-friendly)
///
/// This struct contains only the parameters needed for search logic,
/// excluding CLI-specific concerns like output formatting and colors.
///
/// # Example
///
/// ```rust
/// use rdump::SearchOptions;
/// use std::path::PathBuf;
///
/// let options = SearchOptions {
///     root: PathBuf::from("/path/to/project"),
///     presets: vec!["rust".to_string()],
///     max_depth: Some(5),
///     ..Default::default()
/// };
/// ```
///
/// # Default Values
///
/// | Field | Default |
/// |-------|---------|
/// | `root` | Current directory (`.`) |
/// | `presets` | Empty (no filtering) |
/// | `no_ignore` | `false` (respect .gitignore) |
/// | `hidden` | `false` (skip hidden files) |
/// | `max_depth` | `None` (unlimited) |
/// | `sql_dialect` | `None` (auto-detect) |
#[derive(Debug, Clone)]
pub struct SearchOptions {
    /// Root directory to search from
    ///
    /// This is the starting point for the directory walk. Only files
    /// under this directory will be searched.
    pub root: PathBuf,

    // ... other fields with similar documentation
}
```

### Testing

**Test Location:** Doc tests in `src/lib.rs`

**Verification:**
- `cargo doc` generates without warnings
- `cargo test --doc` passes
- All examples compile and run
- [Source: docs/architecture.md#test-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-21 | 0.1 | Initial draft | SM Agent |
