# Story 1.19: Async Feature Flag Setup

## Status
Draft

## Story
**As a** library user,
**I want** a feature flag for optional async support using tokio,
**so that** I can integrate rdump into async applications without adding async dependencies if I don't need them.

## Acceptance Criteria

**Cargo.toml:**
1. - [ ] `async` feature defined
2. - [ ] All async dependencies are optional
3. - [ ] Version specifications are compatible
4. - [ ] Features use `dep:` syntax for clarity

**Build Verification:**
5. - [ ] `cargo build` succeeds (no async)
6. - [ ] `cargo build --features async` succeeds
7. - [ ] `cargo build --all-features` succeeds
8. - [ ] No warnings about unused dependencies

**Documentation:**
9. - [ ] Feature documented in lib.rs module docs
10. - [ ] Cargo.toml has description comment for feature

**Testing:**
11. - [ ] `cargo test` passes without feature
12. - [ ] `cargo test --features async` passes
13. - [ ] CI tests both configurations

## Tasks / Subtasks

- [ ] Update `Cargo.toml` with async feature (AC: 1, 2, 3, 4)
  - [ ] Define `async` feature
  - [ ] Add optional tokio dependency
  - [ ] Add optional tokio-stream dependency
  - [ ] Add optional futures dependency
  - [ ] Add tokio/futures to dev-dependencies for tests
- [ ] Add feature gate placeholders in code
  - [ ] `#[cfg(feature = "async")]` in lib.rs
- [ ] Document feature in lib.rs (AC: 9)
- [ ] Verify all build configurations (AC: 5, 6, 7, 8)
- [ ] Test both configurations (AC: 11, 12)

## Dev Notes

### Location
- Primary file: `Cargo.toml`
- [Source: docs/epics/library-api-epic.md - Story 19]

### Why Optional Async?
Not all users need async support. Making it optional:
1. Reduces compile time for sync-only users
2. Avoids tokio dependency weight (~3MB of deps)
3. Keeps the default API simple
4. Follows Rust ecosystem conventions

### Tokio Feature Selection
We need these tokio features:
- `fs` - for potential async file reading in future
- `sync` - for mpsc channels
- `rt` - for spawn_blocking
- `macros` - for `#[tokio::main]` in examples

### dep: Syntax
Using `dep:tokio` instead of `"tokio"` in features:
```toml
# Better - explicitly enables dependency
async = ["dep:tokio", "dep:tokio-stream"]

# Older style - less clear
# async = ["tokio", "tokio-stream"]
```

### Complete Implementation

#### Cargo.toml Changes

```toml
[package]
name = "rdump"
version = "0.1.0"
edition = "2021"
description = "Semantic code search using tree-sitter"
license = "MIT"
repository = "https://github.com/your-org/rdump"
keywords = ["search", "code", "tree-sitter", "semantic"]
categories = ["command-line-utilities", "development-tools"]

# ... existing content ...

[features]
default = []

# Enable async API with tokio support
async = ["dep:tokio", "dep:tokio-stream", "dep:futures"]

[dependencies]
# Existing dependencies
anyhow = "1"
rayon = "1"
tree-sitter = "0.20"
ignore = "0.4"
# ... other existing deps ...

# Optional async dependencies
tokio = { version = "1", features = ["fs", "sync", "rt", "macros"], optional = true }
tokio-stream = { version = "0.1", optional = true }
futures = { version = "0.3", optional = true }

[dev-dependencies]
tempfile = "3"
# For async tests
tokio = { version = "1", features = ["full"] }
futures = "0.3"
```

#### Feature Gate Usage in Code

In `src/lib.rs`:
```rust
// Conditionally compile async module
#[cfg(feature = "async")]
mod async_api;

#[cfg(feature = "async")]
pub use async_api::{search_async, search_all_async};
```

#### Documentation Update

Add to lib.rs module docs:
```rust
//! ## Feature Flags
//!
//! - **`async`** - Enable async API with tokio support
//!
//!   Adds `search_async()` and `search_all_async()` functions for use in
//!   async applications. Requires tokio runtime.
//!
//!   ```toml
//!   [dependencies]
//!   rdump = { version = "0.1", features = ["async"] }
//!   ```
```

### Testing

**Test Location:** Build and test verification

**Verification:**
- Build without feature
- Build with feature
- Build with all features
- Test both configurations
- [Source: docs/architecture.md#test-strategy]

**Build Commands:**
```bash
# Test without async feature
cargo build
cargo test

# Test with async feature
cargo build --features async
cargo test --features async

# Test all features
cargo build --all-features
cargo test --all-features
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-21 | 0.1 | Initial draft | SM Agent |
